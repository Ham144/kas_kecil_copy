name: Deploy to Production (Local Ubuntu)

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: self-hosted

    # pastikan sudah terinstall di server tujuan :
    # - nodejs
    # - npm
    # - pm2 dan sudah setup
    # - git
    # - postgresql
    # - nginx dan sudah setup
    - name: Deploy and Restart App
    run: |
          echo "ğŸš€ Mulai deploy di self-hosted runner..."

          cd /home/ham/kas_kecil_copy || { echo "âŒ Folder project tidak ditemukan"; exit 1; }

          # Pastikan repo valid
          if [ ! -d ".git" ]; then
            echo "âš ï¸ Folder ini bukan repo git, tolong pastikan sudah di-clone manual."
            exit 1
          fi

          echo "ğŸ” Menarik update dari master..."
          git reset --hard
          git clean -fd
          git pull origin master

          echo "ğŸ§± Build frontend..."
          cd frontend-next
          npm install
          npm run build

          echo "âš™ï¸ Build backend..."
          cd ../backend-nest
          npm install
          npx prisma migrate deploy || echo "âš ï¸ Prisma migrate dilewati"
          npm run build

          echo "â™»ï¸ Restart PM2..."
          pm2 restart all || pm2 start dist/main.js --name backend

          echo "âœ… Deploy selesai dengan sukses!"

