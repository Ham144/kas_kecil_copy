name: Deploy to Production (Local Ubuntu)

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: self-hosted

    # pastikan sudah terinstall di server tujuan :
    # - nodejs
    # - pnpm atau npm based on dev
    # - pm2 dan sudah setup
    # - git
    # - postgresql
    # - nginx dan sudah setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy and Restart App
        run: |
          echo "ğŸš€ Mulai deploy di self-hosted runner..."

          npm install -g pnpm


          cd /home/ham/kas_kecil_copy || { echo "âŒ Folder project tidak ditemukan"; exit 1; }

          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          echo "ğŸ” Menarik update dari master..."
          git reset --hard
          git clean -fd
          git pull origin master

          echo "ğŸ“‚ Cek struktur folder:"
          ls -la

          echo "ğŸ§± Build frontend..."
          cd frontend-next
          pnpm install
          pnpm run build

          echo "âš™ï¸ Build backend..."
          cd ../backend-nest
          pnpm install
          npx prisma migrate deploy || echo "âš ï¸ Prisma migrate dilewati"
          pnpm run build

          echo "â™»ï¸ Restart PM2..."
          pm2 restart all || pm2 start dist/main.js --name backend

          echo "âœ… Deploy sukses!"
