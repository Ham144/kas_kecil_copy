name: Deploy to Production (Local Ubuntu)

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: self-hosted

    # pastikan sudah terinstall di server tujuan :
    # - nodejs
    # - npm
    # - pm2 dan sudah setup
    # - git
    # - postgresql
    # - nginx dan sudah setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy and Restart App
        run: |
          cd /home/ham

          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          if [ ! -d "kas_kecil_copy" ]; then
            echo "ğŸ“¦ Folder belum ada, cloning..."
            git clone git@github.com:Ham144/kas_kecil_copy.git
          else
            echo "ğŸ” Folder sudah ada, pull update..."
            cd kas_kecil_copy
            git pull origin master
            cd ..
          fi

          cd kas_kecil_copy/frontend-next
          pnpm install
          pnpm run build

          cd ../backend-nest
          pnpm install
          pnpm run build

          pm2 restart all || pm2 start dist/main.js --name backend

          pm2 restart all || pm2 start dist/main.js --name frontend
